#!/usr/bin/env bash
# claude-verify pre-commit hook
#
# This hook runs verification on staged files before allowing a commit.
# It integrates with claude-verify to ensure code quality.
#
# Installation:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use: claude-verify install-hooks
#
# Configuration via .claude-context.toml:
#   [verification]
#   required = ["compile", "lint", "test"]
#   on_failure = "block"  # or "warn"

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
CLAUDE_VERIFY="${CLAUDE_VERIFY:-claude-verify}"
FAIL_ON_ERROR="${CLAUDE_VERIFY_FAIL_ON_ERROR:-true}"
VERBOSE="${CLAUDE_VERIFY_VERBOSE:-false}"

# Functions
log_info() {
    echo -e "${BLUE}[claude-verify]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[claude-verify]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[claude-verify]${NC} $1"
}

log_error() {
    echo -e "${RED}[claude-verify]${NC} $1"
}

# Check if claude-verify is installed
if ! command -v "$CLAUDE_VERIFY" &> /dev/null; then
    log_warning "claude-verify not found in PATH"
    log_warning "Install with: cabal install claude-verify"
    log_warning "Skipping verification..."
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    log_info "No staged files to verify"
    exit 0
fi

# Filter by supported extensions
VERIFIABLE_FILES=""
for file in $STAGED_FILES; do
    case "$file" in
        *.rs|*.hs|*.lhs|*.adb|*.ads|*.ex|*.exs|*.ml|*.mli)
            VERIFIABLE_FILES="$VERIFIABLE_FILES $file"
            ;;
    esac
done

if [ -z "$VERIFIABLE_FILES" ]; then
    log_info "No verifiable files in commit"
    exit 0
fi

# Count files
FILE_COUNT=$(echo "$VERIFIABLE_FILES" | wc -w | tr -d ' ')
log_info "Verifying $FILE_COUNT file(s)..."

# Run verification
FAILED=0
PASSED=0
WARNINGS=0

for file in $VERIFIABLE_FILES; do
    if [ "$VERBOSE" = "true" ]; then
        log_info "Checking $file..."
    fi

    # Run claude-verify check
    if OUTPUT=$("$CLAUDE_VERIFY" check "$file" 2>&1); then
        ((PASSED++)) || true

        # Check for warnings
        if echo "$OUTPUT" | grep -q "warning"; then
            ((WARNINGS++)) || true
            if [ "$VERBOSE" = "true" ]; then
                log_warning "$file has warnings"
            fi
        fi
    else
        ((FAILED++)) || true
        log_error "Failed: $file"
        if [ "$VERBOSE" = "true" ]; then
            echo "$OUTPUT"
        fi
    fi
done

# Summary
echo ""
if [ $FAILED -eq 0 ]; then
    log_success "All $PASSED file(s) passed verification"
    if [ $WARNINGS -gt 0 ]; then
        log_warning "$WARNINGS file(s) have warnings"
    fi
    exit 0
else
    log_error "$FAILED file(s) failed verification"
    log_success "$PASSED file(s) passed"

    if [ "$FAIL_ON_ERROR" = "true" ]; then
        log_error "Commit blocked. Fix errors or use --no-verify to skip."
        exit 1
    else
        log_warning "Proceeding despite errors (CLAUDE_VERIFY_FAIL_ON_ERROR=false)"
        exit 0
    fi
fi
